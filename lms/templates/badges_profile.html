<%!
  from django.core.urlresolvers import reverse
  from courseware.courses import course_image_url, get_course_about_section
  from courseware.access import has_access
  from certificates.models import CertificateStatuses
%>
<%inherit file="main.html" />

<%namespace name='static' file='static_content.html'/>

<%block name="title"><title>Profile</title></%block>

<%block name="js_extra">
  <script type="text/javascript" src="http://beta.openbadges.org/issuer.js"></script>
  <script type="text/javascript">
  (function() {

    var carouselPageHeight = 0;
    var carouselIndex = 0;
    var carouselDelay = 5000;
    var carouselPages = $('.news-carousel .page').length;


    $('.news-carousel .page').each(function() {
      carouselPageHeight = Math.max($(this).outerHeight(), carouselPageHeight);
    });
    $('.news-carousel .pages').css('height', carouselPageHeight);
    $('.news-carousel .page-dot').bind('click', setCarouselPage);
    var carouselTimer = setInterval(nextCarouselPage, carouselDelay);

    function nextCarouselPage() {
      carouselIndex = carouselIndex + 1 < carouselPages ? carouselIndex + 1 : 0;
      setCarouselPage(null, carouselIndex);
    }

    function setCarouselPage(event, index) {
      var $pageToShow;
      var transitionSpeed;
      $('.news-carousel .page-dots').find('.current').removeClass('current');

      if(event) {
        clearInterval(carouselTimer);
        carouselTimer = setInterval(nextCarouselPage, carouselDelay);
        carouselIndex = $(this).closest('li').index();
        transitionSpeed = 250;
        $pageToShow = $('.news-carousel .page').eq(carouselIndex);
        $(this).addClass('current');
      } else {
        transitionSpeed = 750;
        $pageToShow = $('.news-carousel .page').eq(index);
        $('.news-carousel .page-dot').eq(index).addClass('current');
      }

      $pageToShow.fadeIn(transitionSpeed);
      $('.news-carousel .page').not($pageToShow).fadeOut(transitionSpeed);
    }

    $(".unenroll").click(function(event) {
      $("#unenroll_course_id").val( $(event.target).data("course-id") );
      $("#unenroll_course_number").text( $(event.target).data("course-number") );
    });

    $('#unenroll_form').on('ajax:complete', function(event, xhr) {
      if(xhr.status == 200) {
        location.href = "${reverse('dashboard')}";
      } else if (xhr.status == 403) {
        location.href = "${reverse('signin_user')}?course_id=" +
          $("#unenroll_course_id").val() + "&enrollment_action=unenroll";
      } else {
        $('#unenroll_error').html(
          xhr.responseText ? xhr.responseText : "An error occurred. Please try again later."
        ).stop().css("display", "block");
      }
    });

    $('#pwd_reset_button').click(function() {
      $.post('${reverse("password_reset")}',
             {"email"  : $('#id_email').val()},
             function(data){
               $("#password_reset_complete_link").click();
             });
    });

    $("#change_email_form").submit(function(){
      var new_email = $('#new_email_field').val();
      var new_password = $('#new_email_password').val();

      $.post('${reverse("change_email")}',
               {"new_email" : new_email, "password" : new_password},
               function(data) {
                 if (data.success) {
                   $("#change_email_title").html("Please verify your new email");
                   $("#change_email_form").html("<p>You'll receive a confirmation in your " +
                                                "in-box. Please click the link in the " +
                                                "email to confirm the email change.</p>");
                 } else {
                   $("#change_email_error").html(data.error).stop().css("display", "block");
                 }
               });
      return false;
    });

    $("#change_name_form").submit(function(){
      var new_name = $('#new_name_field').val();
      var rationale = $('#name_rationale_field').val();

      $.post('${reverse("change_name")}',
             {"new_name":new_name, "rationale":rationale},
             function(data) {
               if(data.success) {
                 location.reload();
                 // $("#change_name_body").html("<p>Name changed.</p>");
               } else {
                 $("#change_name_error").html(data.error).stop().css("display", "block");
               }
             });
       return false;
    });

  })(this)
  </script>
  <script>

  $(document).ready(function() {

    var start_info_button = function() {
        $('#badge_info_button').html('▸ Learn more');
        $('#badge_info').hide();
    };
    start_info_button();

    $('input#badge_export').click(function() {
      OpenBadges.issue(${badge_data['badge_urls']}, function(e,s) {});
    });


    var badge_info_visible = false;
    var flip_info_button = function() {
      if (badge_info_visible) {
        $('#badge_info_button').html('▸ Learn more');
        $('#badge_info').hide('blind');
      }
      else {
        $('#badge_info_button').html('▾ Learn more');
        $('#badge_info').show('blind');
      }
      badge_info_visible = !badge_info_visible;
    };
    $('#badge_info_button').click(flip_info_button);


  });

</script>
</%block>

<section class="container dashboard">

  %if message:
    <section class="dashboard-banner">
      ${message}
    </section>
  %endif

  <section class="profile-sidebar">
    <header class="profile">
      <h1 class="user-name">${ user.username }</h1>
    </header>
    <section class="user-info">
      <ul>
        <li>
          <span class="title"><div class="icon name-icon"></div>Full Name (<a href="#apply_name_change" rel="leanModal" class="edit-name">edit</a>)</span> <span class="data">${ user.profile.name | h }</span>
        </li>
        <li>
          <span class="title"><div class="icon email-icon"></div>Email
            % if external_auth_map is None or 'shib' not in external_auth_map.external_domain:
            (<a href="#change_email" rel="leanModal" class="edit-email">edit</a>)
            % endif
          </span> <span class="data">${ user.email | h }</span>
        </li>

        % if external_auth_map is None or 'shib' not in external_auth_map.external_domain:
        <li>
          <span class="title"><a href="#password_reset_complete" rel="leanModal" id="pwd_reset_button">Reset Password</a></span>
          <form id="password_reset_form" method="post" data-remote="true" action="${reverse('password_reset')}">
            <input id="id_email" type="hidden" name="email" maxlength="75" value="${user.email}" />
            <!-- <input type="submit" id="pwd_reset_button" value="Reset Password" /> -->
          </form>
        </li>
        % endif

      </ul>
    </section>

    ## `news` should be `None` whenever a non-edX theme is enabled:
    ## see common/djangoapps/student/views.py#_get_news
    %if news:
    <article class="news-carousel">
      <header>
        <h4>edX News</h4>
        <nav class="page-dots">
          <ol>
            <li><a href="#" class="page-dot current"></a></li>
            <li><a href="#" class="page-dot"></a></li>
            <li><a href="#" class="page-dot"></a></li>
          </ol>
        </nav>
      </header>
      <div class="pages">
        % for entry in news:
        <section class="page">
          %if entry.image:
          <div class="news-image">
            <a href="${entry.link}"><img src="${entry.image}" /></a>
          </div>
          %endif
          <h5><a href="${entry.link}">${entry.title}</a></h5>
          <div class="excerpt">
            %if entry.summary:
            <p>${entry.summary}</p>
            %endif
            <p><a href="${entry.link}">Learn More ›</a></p>
          </div>
        </section>
        %endfor
      </div>
    </article>
    %endif
  </section>

  <section class="my-courses">
    <header>
      <h2>All Badges (prototype)</h2>
    </header>
      <p><a id="badge_info_button" style="float:right; cursor:pointer"></a>

        If you wish, you can export these badges to <a href="http://beta.openbadges.org/">Mozilla Backpack</a> to share them.</p>

      <br />
      <div id="badge_info">
      <hr />
      <input type="button" id="badge_export" value="Export All" style="float:right;" />

      <p>
        These badges are <a href="http://openbadges.org/">Mozilla Open Badges</a>, which means you can save them in <a href="http://beta.openbadges.org/">Mozilla Backpack</a>, a separate website which stores badges. You can display and share the badges elsewhere on the Internet, along with any badges you collect from other websites. Log in to Mozilla Backpack using your <b>${user.email}</b> email address.
      </p>
      </div>
      <hr />

      %for i in range(len(badge_data['earned_badges'])):
        <%badge = badge_data['earned_badges'][i]%>
          <table><tr>
            <td><img src="${badge['image']}" style="float:left; width:100px; margin-right:20px;" /></td>
            <td>
              <h3>${badge['badge']['name']}</h3>
              <p><b>${badge['badge']['description']}</b><br />
                issued on <i>${badge['issuedOn']}</i> by
                <a href="${badge['badge']['issuer']['origin']}">${badge['badge']['issuer']['name']}</a>
                %if badge['badge']['custom'].get('course', None):
                  <br /><i><a href = "/courses/${badge['badge']['custom']['course']}/badges">all badges for this course</a></i>
                %endif
              </p>
            </td>
          </tr></table>
          <hr />
      %endfor

  </section>
</section>


<section id="password_reset_complete" class="modal">
  <div class="inner-wrapper">
    <header>
      <h2>Password Reset Email Sent</h2>
      <hr/>
    </header>
    <div>
      <form> <!-- Here for styling reasons -->
        <section>
          <p>An email has been sent to ${user.email}. Follow the link in the email to change your password.</p>
        </section>
      </form>
    </div>
    <div class="close-modal">
      <div class="inner">
        <p>&#10005;</p>
      </div>
    </div>
  </div>
</section>

<section id="change_email" class="modal">
  <div class="inner-wrapper">
    <header>
      <h2><span id="change_email_title">Change Email</span></h2>
      <hr/>
    </header>
    <div id="change_email_body">
      <form id="change_email_form">
        <div id="change_email_error" class="modal-form-error"> </div>
        <fieldset>
          <div class="input-group">
            <label>Please enter your new email address:</label>
            <input id="new_email_field" type="email" value="" />
            <label>Please confirm your password:</label>
            <input id="new_email_password" value="" type="password" />
          </div>
          <section>
            <p>We will send a confirmation to both ${user.email} and your new email as part of the process.</p>
          </section>
          <div class="submit">
            <input type="submit" id="submit_email_change" value="Change Email"/>
          </div>
        </fieldset>
      </form>
    </div>
    <div class="close-modal">
      <div class="inner">
        <p>&#10005;</p>
      </div>
    </div>
  </div>
</section>

<section id="apply_name_change" class="modal">
  <div class="inner-wrapper">
    <header>
      <h2>Change your name</h2>
      <hr/>
    </header>
    <div id="change_name_body">
      <form id="change_name_form">
        <div id="change_name_error" class="modal-form-error"> </div>
        <p>To uphold the credibility of ${settings.PLATFORM_NAME} certificates, all name changes will be logged and recorded.</p>
        <br/>
        <fieldset>
          <div class="input-group">
            <label>Enter your desired full name, as it will appear on the ${settings.PLATFORM_NAME} certificates: </label>
            <input id="new_name_field" value="" type="text" />
            <label>Reason for name change:</label>
            <textarea id="name_rationale_field" value=""></textarea>
          </div>
          <div class="submit">
            <input type="submit" id="submit" value="Change My Name">
          </div>
        </fieldset>
      </form>
    </div>
    <div class="close-modal">
      <div class="inner">
        <p>&#10005;</p>
      </div>
    </div>
  </div>
</section>
